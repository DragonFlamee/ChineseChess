

# 中国象棋联机对战系统 (Chinese Chess Online)

这是一个基于 Java Swing 开发的中国象棋联机对战系统。系统采用 **客户端-服务器 (C/S)** 架构，通过 Socket 编程实现两名玩家的实时对弈、胜负判定、即时聊天及**实时语音通讯**功能。

---

## 1. 项目结构与核心类

### 核心逻辑 (Core Logic)

* **ChessPiece.java**: 抽象基类，定义棋子的颜色、类型、坐标及通用绘制方法。
* **各棋子实现类**: 包含 `General` (将), `Advisor` (士), `Elephant` (象), `Chariot` (车), `Cannon` (炮) 等，重写了 `moveLogic` 走子逻辑。

### 网络与界面 (Networking & UI)

* **ChessServer.java**: 服务端。负责管理连接、分配阵营并中转消息。
* **ChessClient.java**: 客户端网络模块。封装了 Socket 通信、消息解析接口及**语音发送逻辑**。
* **GamePanel.java**: 核心 UI。处理用户点击、渲染棋盘、同步远程走子、展示聊天记录及语音交互。
* **GameMain.java**: 程序的启动入口。

### 媒体工具 (Media)

* **AudioUtils.java**: **[新增]** 语音处理工具类。基于 `javax.sound.sampled` 实现音频的 PCM 采样录制与线性播放。

---

## 2. 启动方式详解 (详细步骤)

本系统必须按顺序启动，确保两个客户端连接到同一服务端。

### 第一步：启动服务器 (Server)

1. **运行类**：`ChessServer.java`。
2. **逻辑**：默认监听 **12345** 端口，等待两名玩家接入。
3. **现象**：控制台输出 “服务器启动，等待玩家连接...”。

### 第二步：启动客户端 A (红方)

1. **运行类**：`GameMain.java`。
2. **角色**：首个连接的玩家被服务端自动分配为 `Side.RED`（红方）。
3. **现象**：提示“等待另一位玩家加入...”，并在红方连接成功后初始化数据库对局记录。

### 第三步：启动客户端 B (黑方)

1. **运行类**：再次启动 `GameMain.java`。
2. **角色**：第二个连接者分配为 `Side.BLACK`（黑方）。
3. **开始**：当两名玩家就位，服务端发送 `START` 指令，双端弹出“游戏开始！”。

---

## 3. 语音通讯功能实现

系统集成了实时语音消息功能，增强了对弈过程中的互动性。

### 3.1 技术原理

* **音频采集**：采用 16,000Hz 采样率、16位、单声道格式录制 PCM 数据。
* **数据编码**：由于系统基于文本流传输，音频字节数组（`byte[]`）在发送前会被转换为 **Base64 字符串**。
* **异步机制**：录音与播放均在独立线程运行，确保在发送大容量语音数据时 UI 界面不会出现卡死。

### 3.2 跨电脑联机建议

1. **获取 IP**：在服务端电脑运行 `ipconfig` 获取局域网 IPv4。
2. **修改连接**：将 `GamePanel` 中的连接地址 `127.0.0.1` 修改为服务端的局域网 IP。
3. **防火墙**：确保服务端电脑的 **12345** 端口已在防火墙入站规则中开启。

---

## 4. 网络通信协议与数据格式

系统通过 `BufferedReader` 和 `PrintWriter` 进行基于文本行的实时指令传输。

### 4.1 指令格式表

| 指令前缀 | 形式示例 | 说明 |
| --- | --- | --- |
| `坐标` | `7,1,9,2` | 代表棋子起始点与终点的坐标。 |
| `CHAT:` | `CHAT:你好` | 发送/接收普通文字消息。 |
| `VOICE:` | `VOICE:U29u...` | **[新增]** 发送 Base64 编码的音频数据。 |
| `SIDE:` | `SIDE:RED` | 服务器分配阵营回调。 |
| `START` | `START` | 触发游戏开始逻辑。 |
| `WIN:` | `WIN:RED` | 触发胜负判定与结算。 |

---

## 5. 数据库持久化实现 (Database Implementation)

系统集成 MySQL 数据库，用于记录对局元数据及详细步数。

### 5.1 数据库结构

* **games 表**：存储对局 ID、玩家阵营、开始时间。
* **moves 表**：记录每一步的 `game_id`、走子方、棋子名称及起止坐标。

### 5.2 数据一致性策略

* **单点创建**：仅由红方在对局开始时创建 `games` 记录，并通过 `SYSTEM_GAME_ID` 指令同步给黑方。
* **异步写入**：每次行棋后的数据库插入操作均在后台线程完成，不占用主线程资源。

---

## 6. 技术特性

* **Swing 线程安全**：所有由网络触发的界面更新均包裹在 `SwingUtilities.invokeLater` 中。
* **逻辑校验**：本地与远程走子均需通过 `moveLogic` 校验，确保游戏规则的强制执行。
* **扩展性**：支持通过 Base64 协议扩展发送图片或表情包功能。

---
